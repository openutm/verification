name: Integration Test

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
    - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  unit-tests:
    timeout-minutes: 10
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v5

    - name: Install uv
      uses: astral-sh/setup-uv@v6

    - name: Install Verification framework and all dependencies
      run: uv sync --locked --all-extras --dev

    - name: Run unit tests
      run: uv run pytest tests

  integration-tests:
    needs: unit-tests
    timeout-minutes: 30
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v5

    - name: Set up Docker Compose
      uses: docker/setup-compose-action@v1
      with:
        version: latest

    - name: Start Flight Blender and dependencies
      run: docker compose --env-file .env.tests -f docker-compose.fb.yml up -d --wait
      working-directory: ./tests

    - name: Install uv
      uses: astral-sh/setup-uv@v6

    - name: Install Verification framework and all dependencies
      run: uv sync --locked --all-extras --dev

    - name: Run tests
      run: uv run openutm-verify --debug --config config/default.yaml -s pull_requests

    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: reports/

    - name: Stop containers
      if: always()
      run: docker compose --env-file .env.tests -f docker-compose.fb.yml down
      working-directory: ./tests
